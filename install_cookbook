#!/usr/bin/env ruby

# Copyright 2012, Mirantis

require 'rubygems'
require 'tmpdir'
require 'json'
require 'httpclient'
require 'chef'

puts "Provide path to cookbook for uploading" if ARGV.length == 0

ARGV.each do |src|
  case
  #when /tar\.gz$/ =~ src
    ## Could be cookbook
    #tmpdir = Dir.mktmpdir
    #src=File.expand_path(src)
    #system "tar xzf \"#{src}\" -C \"#{tmpdir}\""
  when File.exists?(File.join(src, "metadata.rb"))
    # It's cookbook folder
    md = Chef::Cookbook::Metadata.new
    md.from_file(File.expand_path(File.join(src, "metadata.rb")))

    cook_name = md.name.empty? ? File.basename(src) : md.name

    base_url = "http://127.0.0.1:8000/api"
    cooks_url = "#{base_url}/cookbooks"

    cook_data = {'name' => cook_name, 'version' => md.version }
    headers = {"Content-Type" => "application/json"}

    cli = HTTPClient.new
    begin
      res = cli.post(cooks_url, cook_data.to_json, headers)
      if res.status < 200 or res.status >= 300
        puts "Error uploading cookbook metadata: #{res.inspect}"
      end
    rescue Exception => e
      puts "Unknown error: #{e.message}"
    end

  end
end
